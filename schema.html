<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Struttura a Nodi â€“ Fluida e Ordinata</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      svg {
        width: 100vw;
        height: 100vh;
        background: #f8f8f8;
      }
      .node rect {
        fill: white;
        stroke: #333;
        stroke-width: 1.5;
        rx: 4;
        ry: 4;
      }
      .node text {
        font: 12px monospace;
        pointer-events: none;
      }
      .link {
        fill: none;
        stroke: #999;
        stroke-width: 1.5px;
        marker-end: url(#arrow);
      }
    </style>
  </head>
  <body>
    <svg></svg>
    <script>
      // Nodi esattamente come definiti da te
      const nodes = [
        { id: "1" },
        { id: "1.1", parent: "1" },
        { id: "1.1.1", parent: "1.1" },
        { id: "1.1.2", parent: "1.1" },
        { id: "1.1.2.1", parent: "1.1.2" },
        { id: "handle" },
        { id: "handle.1", parent: "handle" },
        { id: "handle.2" },
        { id: "1.2", parent: "1" },
        { id: "1.3", parent: "1" },
        { id: "1.3.1", parent: "1.3" },
        { id: "1.3.2", parent: "1.3" },
        { id: "1.3.3", parent: "1.3" },
        { id: "1.3.1+1.3.2" },
        { id: "ideasperimentale.1", parent: "1.3.1+1.3.2" },
        { id: "handle.2+ideasperimentale.1" },
        { id: "1.3.2+1.3.3" },
        { id: "(1.3.2+1.3.3)+1.2" },
      ];

      const links = [
        { source: "1", target: "1.1" },
        { source: "1.1", target: "1.1.1" },
        { source: "1.1", target: "1.1.2" },
        { source: "1.1.2", target: "1.1.2.1" },
        { source: "1.1.2.1", target: "handle" },
        { source: "handle", target: "handle.1" },
        { source: "1", target: "1.2" },
        { source: "1", target: "1.3" },
        { source: "1.3", target: "1.3.1" },
        { source: "1.3", target: "1.3.2" },
        { source: "1.3", target: "1.3.3" },
        { source: "1.3.1", target: "1.3.1+1.3.2" },
        { source: "1.3.2", target: "1.3.1+1.3.2" },
        { source: "1.3.1+1.3.2", target: "ideasperimentale.1" },
        { source: "handle.2", target: "handle.2+ideasperimentale.1" },
        { source: "ideasperimentale.1", target: "handle.2+ideasperimentale.1" },
        { source: "1.3.2", target: "1.3.2+1.3.3" },
        { source: "1.3.3", target: "1.3.2+1.3.3" },
        { source: "1.3.2+1.3.3", target: "(1.3.2+1.3.3)+1.2" },
        { source: "1.2", target: "(1.3.2+1.3.3)+1.2" },
      ];

      const svg = d3.select("svg");

      // Frecce
      svg
        .append("defs")
        .append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 10)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#999");

      // Simulazione
      const simulation = d3
        .forceSimulation(nodes)
        .force(
          "link",
          d3
            .forceLink(links)
            .id((d) => d.id)
            .distance(150)
        )
        .force("charge", d3.forceManyBody().strength(-800))
        .force(
          "x",
          d3
            .forceX()
            .strength(0.1)
            .x((d) => 50 + d.id.length * 35)
        ) // spinta orizzontale
        .force(
          "y",
          d3
            .forceY()
            .strength(0.1)
            .y(window.innerHeight / 2)
        );

      // Collegamenti
      const link = svg
        .append("g")
        .selectAll("path")
        .data(links)
        .join("path")
        .attr("class", "link");

      // Nodi
      const node = svg
        .append("g")
        .selectAll("g")
        .data(nodes)
        .join("g")
        .attr("class", "node")
        .call(
          d3
            .drag()
            .on("start", (event, d) => {
              if (!event.active) simulation.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
            })
            .on("drag", (event, d) => {
              d.fx = event.x;
              d.fy = event.y;
            })
            .on("end", (event, d) => {
              if (!event.active) simulation.alphaTarget(0);
              d.fx = null;
              d.fy = null;
            })
        );

      node
        .append("rect")
        .attr("width", (d) => d.id.length * 8 + 20)
        .attr("height", 30)
        .attr("x", (d) => -((d.id.length * 8 + 20) / 2))
        .attr("y", -15);

      node
        .append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em")
        .text((d) => d.id);

      // Tick
      simulation.on("tick", () => {
        link.attr(
          "d",
          d3
            .linkHorizontal()
            .x((d) => d.x)
            .y((d) => d.y)
        );
        node.attr("transform", (d) => `translate(${d.x},${d.y})`);
      });
    </script>
  </body>
</html>
