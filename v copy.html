<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>3D Visualizer – Threadscape</title>
  <style>
    html, body, #scene { height: 100%; margin: 0; background: #0c0c0c; color: #eee; font: 14px/1.4 system-ui; }
    .toolbar { position: fixed; top: 8px; right: 8px; display: flex; gap: 8px; z-index: 10; }
    .toolbar button, .toolbar label { background: #141414; border: 1px solid #333; color: #eee; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .panel { position: fixed; left: 8px; top: 8px; background: rgba(0,0,0,0.6); border:1px solid #333; padding:8px; border-radius:8px; max-width: 320px; backdrop-filter: blur(2px);}
    .panel h3 { margin: 0 0 6px 0; font-size: 13px; color:#bbb; }
    .muted { color: #aaa; font-size: 12px }
    .tooltip { position: fixed; pointer-events: none; background:#111; border:1px solid #333; color:#eee; padding:6px 8px; border-radius:6px; font-size:12px; max-width:360px; display:none; }
  </style>
  <script src="https://unpkg.com/3d-force-graph"></script>
</head>
<body>
  <div id="scene"></div>
  <div class="toolbar">
    <label>
      <input id="file" type="file" accept="application/json" style="display:none">
      Carica JSON…
    </label>
    <button id="btnLoadExample">Apri graphdata.json</button>
    <button id="btnFit">Fit</button>
    <button id="btnToggleLabels">Labels</button>
  </div>
  <div class="panel">
    <h3>Legenda</h3>
    <div class="muted">Colore = <em>group</em> (mainArea/area).</div>
    <div class="muted">Hover per dettagli; click per bloccare focus.</div>
  </div>
  <div id="tooltip" class="tooltip"></div>
  <script>
    const el = document.getElementById('scene');
    const Graph = ForceGraph3D()(el)
      .backgroundColor('#0c0c0c')
      .nodeRelSize(6)
      .nodeAutoColorBy('group')
      .linkOpacity(0.35)
      .linkDirectionalParticles(0)
      .enableNodeDrag(true)
      .onNodeHover((node) => showTip(node))
      .onNodeClick(node => { Graph.centerAt(node.x, node.y, 500); Graph.zoom(3, 800); lastPinned = node; })
      .nodeLabel(n => n.name);

    let lastPinned = null;
    let showLabels = true;

    function showTip(node) {
      const tip = document.getElementById('tooltip');
      if (!node) { tip.style.display = 'none'; return; }
      const tags = (node.tags||[]).join(', ');
      const areas = (node.areas||[]).join(', ');
      tip.innerHTML = `<b>${escapeHtml(node.name||node.id)}</b><br>
        <span class="muted">${escapeHtml(node.type||'')} &middot; group=${escapeHtml(node.group||'')} </span><br>
        Areas: ${escapeHtml(areas)}<br>
        Tags: ${escapeHtml(tags)}<br>
        <div style="margin-top:6px">${escapeHtml(node.desc||'')}</div>`;
      tip.style.display = 'block';
      window.onmousemove = (e) => { tip.style.left = (e.clientX+12)+'px'; tip.style.top = (e.clientY+12)+'px'; };
    }

    function escapeHtml(s) {
      if (!s) return '';
      return (''+s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    document.getElementById('btnFit').onclick = () => { Graph.zoomToFit(600, 60); };
    document.getElementById('btnToggleLabels').onclick = () => {
      showLabels = !showLabels;
      Graph.nodeLabel(showLabels ? (n => n.name) : (n => ''));
    };

    document.getElementById('btnLoadExample').onclick = async () => {
      const res = await fetch('graphdata.json').catch(()=>null);
      if (!res) return alert('graphdata.json non trovato nella stessa cartella');
      const data = await res.json();
      Graph.graphData(data);
      setTimeout(()=>Graph.zoomToFit(600,60), 300);
    };

    document.querySelector('label').onclick = () => document.getElementById('file').click();
    document.getElementById('file').onchange = async (e) => {
      const fl = e.target.files[0];
      if (!fl) return;
      const text = await fl.text();
      let data;
      try { data = JSON.parse(text); } catch(e) { return alert('JSON non valido'); }
      // accetta sia project.json (Threadscape) che graphData diretto
      if (data && Array.isArray(data.nodes) && Array.isArray(data.links) && data.nodes.length && ('source' in (data.links[0]||{}) || 's' in (data.links[0]||{}))) {
        if ('s' in (data.links[0]||{})) data = convertProjectToGraphData(data);
        Graph.graphData(data);
        setTimeout(()=>Graph.zoomToFit(600,60), 300);
      } else if (data && data.version && data.nodes && data.edges) {
        Graph.graphData(convertProjectToGraphData(data));
        setTimeout(()=>Graph.zoomToFit(600,60), 300);
      } else {
        alert('Formato non riconosciuto');
      }
    };

    function convertProjectToGraphData(project) {
      const nodes = (project.nodes||[]).map(n => {
        const d = n.data||{};
        return {
          id: n.id,
          name: d.title || n.id,
          group: d.mainArea || (d.areas && d.areas[0]) || 'Other',
          type: d.type || '',
          areas: d.areas || [],
          tags: d.tags || [],
          desc: d.desc || ''
        };
      });
      const seen = new Set();
      const links = (project.edges||[]).map(e => {
        const s = e.s, t = e.t;
        const key = [s,t].sort().join('||'); // de-dup undirected
        if (seen.has(key)) return null;
        seen.add(key);
        return { source: s, target: t, dashed: !!e.dashed };
      }).filter(Boolean);
      return { nodes, links };
    }
  </script>
</body>
</html>
